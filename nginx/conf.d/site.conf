# HTTP: desafio do Let's Encrypt + redirect pro HTTPS
server {
  listen 80;
  server_name infrastack.com.br;

  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  error_page 404 /error/index.html;
  location /error/ {
    alias /var/www/landpage/error/;
    try_files $uri $uri/ /index.html;
  }

  location / {
    return 301 https://$host$request_uri;
  }
}

# HTTPS: reverse proxy por caminho
server {
  listen 443 ssl;
  server_name infrastack.com.br;

  ssl_certificate     /etc/letsencrypt/live/infrastack.com.br/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/infrastack.com.br/privkey.pem;

  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  error_page 404 /error/index.html;
  location /error/ {
    alias /var/www/landpage/error/;
    try_files $uri $uri/ /index.html;
  }

  # Redirecionar raiz para /monitor (opcional)
  location = / {
    root /var/www/landpage;
    try_files /index.html =404;
  }
  location = /index.html {
    root /var/www/landpage;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    try_files /index.html =404;
  }

  # Landpage publica em /LANDPAGE/
  location = /LANDPAGE {
    return 301 /LANDPAGE/;
  }
  location /LANDPAGE/ {
    alias /var/www/landpage/;
    try_files $uri $uri/ /index.html;
  }
  location = /LANDPAGE/index.html {
    alias /var/www/landpage/index.html;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }

  # Area do cliente em /area-cliente/
  location = /area-cliente {
    return 301 /area-cliente/;
  }
  location /area-cliente/ {
    alias /var/www/landpage/area-cliente/;
    try_files $uri $uri/ /index.html;
  }
  location = /area-cliente/index.html {
    alias /var/www/landpage/area-cliente/index.html;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }

  # Atalhos vindos de /monitor
  location = /monitor/area-cliente {
    return 301 /area-cliente/;
  }
  location ^~ /monitor/area-cliente/ {
    return 301 /area-cliente/;
  }

  # Qualquer rota fora de /monitor, /zabbix, /grafana, /area-cliente e /error vai para /monitor
  location / {
    if ($request_uri !~ ^/(monitor|zabbix|grafana|area-cliente|error|\\.well-known|LANDPAGE)(/|$)) {
      return 301 /monitor$request_uri;
    }
    return 302 /monitor/;
  }

  # Fallback para assets absolutos gerados pelo app (sem /monitor)
  location ~* ^/(css|img|js|fonts)/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_pass http://php-monitor:80;
  }

  # ===== MONITOR =====
  # Seu compose: service php-monitor (container php_monitor), porta interna 80
  location = /monitor {
    return 301 /monitor/;
  }
  # Ajuste de CSS para subpath (urls absolutas dentro do CSS)
  location ~* ^/monitor/.*\.css$ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /monitor;
    proxy_set_header Accept-Encoding "";

    rewrite ^/monitor/(.*)$ /$1 break;
    proxy_pass http://php-monitor:80;
    sub_filter_once off;
    sub_filter_types text/css;
    sub_filter 'url(/' 'url(/monitor/';
  }
  location /monitor/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /monitor;
    proxy_intercept_errors on;
    # Disable upstream compression so sub_filter can edit responses.
    proxy_set_header Accept-Encoding "";

    # Mantem /monitor/... no upstream. Se o app nao suportar subpath,
    # pode ser necessario reescrever ou usar subdominio no futuro.
    proxy_pass http://php-monitor:80/;
    proxy_redirect ~^(/.*)$ /monitor$1;
    sub_filter_once off;
    sub_filter 'href="/' 'href="/monitor/';
    sub_filter 'src="/' 'src="/monitor/';
    sub_filter 'action="/' 'action="/monitor/';
  }

  # ===== ZABBIX WEB =====
  # Seu compose: service zabbix-web-apache-mysql, porta interna 8080
  location = /zabbix {
    return 301 /zabbix/;
  }
  location /zabbix/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_pass http://zabbix-web-apache-mysql:8080/;
  }

  # ===== (OPCIONAL) GRAFANA =====
  # Se quiser grafana em /grafana/:
  location = /grafana { return 301 /grafana/; }
  location /grafana/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_pass http://grafana:3000;
  }
}
