# HTTP: desafio do Let's Encrypt + redirect pro HTTPS
server {
  listen 80;
  server_name infrastack.com.br;

  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  location / {
    return 301 https://$host$request_uri;
  }
}

# HTTPS: reverse proxy por caminho
server {
  listen 443 ssl;
  server_name infrastack.com.br;

  ssl_certificate     /etc/letsencrypt/live/infrastack.com.br/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/infrastack.com.br/privkey.pem;

  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }

  # Redirecionar raiz para /monitor (opcional)
  location = / {
    return 302 /monitor/;
  }

  # ===== MONITOR =====
  # Seu compose: service php-monitor (container php_monitor), porta interna 80
  location = /monitor {
    return 301 /monitor/;
  }
  location /monitor/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /monitor;

    # Mantem /monitor/... no upstream. Se o app nao suportar subpath,
    # pode ser necessario reescrever ou usar subdominio no futuro.
    proxy_pass http://php-monitor:80/;
    proxy_redirect ~^(/.*)$ /monitor$1;
    sub_filter_once off;
    sub_filter 'href="/' 'href="/monitor/';
    sub_filter 'src="/' 'src="/monitor/';
  }

  # ===== ZABBIX WEB =====
  # Seu compose: service zabbix-web-apache-mysql, porta interna 8080
  location = /zabbix {
    return 301 /zabbix/;
  }
  location /zabbix/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_pass http://zabbix-web-apache-mysql:8080/;
  }

  # ===== (OPCIONAL) GRAFANA =====
  # Se quiser grafana em /grafana/:
  # location = /grafana { return 301 /grafana/; }
  # location /grafana/ {
  #   proxy_set_header Host $host;
  #   proxy_set_header X-Real-IP $remote_addr;
  #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  #   proxy_set_header X-Forwarded-Proto https;
  #   proxy_pass http://grafana:3000/;
  # }
}
